#!/bin/sh

subdir=$1
topdir=$2
srcdir=$2/$1

echo updating tme modules list..
grep TME_ELEMENT_NEW_DECL $srcdir/*.c |	
    sed -e 's%.*TME_ELEMENT_NEW_DECL(\(.*\)).*%\1%' >> $topdir/tme/tme-plugins.txt
grep TME_ELEMENT_SUB_NEW_DECL $srcdir/*.c |		
    sed -e 's%.*TME_ELEMENT_SUB_NEW_DECL(\(.*\),\(.*\)).*%\1_\2 \1 \2%' >> $topdir/tme/tme-plugins.txt
grep TME_ELEMENT_X_NEW_DECL $srcdir/*.c |		
    sed -e 's%.*TME_ELEMENT_X_NEW_DECL(\(.*\),\(.*\),\(.*\)).*%\1\3 \1\2 \3%' >> $topdir/tme/tme-plugins.txt

moddir=`echo ${subdir} | tr '/' '_'`
echo moddir=${moddir} > $srcdir/moddir.mk
topsub=`echo ${subdir} | awk -F/ '{print $1}'`
pardir=$(basename $subdir)
@PACKAGE@_HOST=`echo ${pardir} | tr '[a-z]' '[A-Z]'`

if test $topsub = host &&
	test $topsub != $subdir; then
    echo if HAVE_${@PACKAGE@_HOST} >> $topdir/tme-preopen.txt 
    echo @PACKAGE@_HOST_CFLAGS += \$(${@PACKAGE@_HOST}_CFLAGS)
    echo @PACKAGE@_PREOPEN += -dlopen \${top_builddir}/${subdir}/@PACKAGE@_${moddir}.la >> $topdir/tme-preopen.txt 
    echo endif >> $topdir/tme-preopen.txt
else
    for num; do
	if test $num = $1 || test $num = $2; then continue; fi
	echo @PACKAGE@_PREOPEN += -dlopen \${top_builddir}/${subdir}/$num >> $topdir/tme-preopen.txt
    fi
    done
fi
